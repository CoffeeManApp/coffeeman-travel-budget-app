<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CoffeeMan Travel Budget</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --bg-color: #f0f9ff;
      --card-bg: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --danger: #ef4444;
      --border-radius: 16px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: var(--primary-dark);
      padding: 15px 20px;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #e0f2fe;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 80px;
    }

    h2, h3 {
      color: var(--text-main);
      margin-bottom: 15px;
      font-weight: 700;
    }

    /* Inputs & Buttons */
    input, select, button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      box-sizing: border-box;
      outline: none;
      transition: all 0.2s;
      font-family: inherit;
    }

    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
    }

    button {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }

    /* Trip List Grid */
    #trip-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .trip-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .trip-card:hover { transform: translateY(-3px); }

    .trip-img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background-color: #eee;
    }

    .trip-info { padding: 12px; }

    .trip-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .delete-trip-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      border-radius: 50%;
      width: 26px; height: 26px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; border: none;
      margin: 0;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      border: 1px solid #f1f5f9;
    }

    /* Navigation */
    .back-btn {
      background: transparent;
      color: var(--primary);
      width: auto;
      padding: 0; margin-bottom: 10px;
      justify-content: flex-start;
      font-size: 16px;
    }
    .back-btn:hover { background: transparent; color: var(--primary-dark); transform: none; }

    /* Budget Progress */
    .budget-overview { text-align: center; margin-top: 20px; }
    .budget-amount-display { font-size: 32px; font-weight: 800; color: var(--primary); margin: 10px 0; }
    .progress-container { background-color: #e2e8f0; border-radius: 10px; height: 12px; width: 100%; margin: 10px 0; overflow: hidden; }
    .progress-bar { background-color: var(--primary); height: 100%; width: 0%; transition: width 0.5s ease; }
    .progress-text { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); }

    /* Forms */
    .input-group { display: flex; gap: 10px; }
    .input-group select { width: 40%; }
    
    input[type="file"] { padding: 10px; background: white; }
    input[type="file"]::file-selector-button {
      background-color: #e0f2fe; color: var(--primary-dark);
      font-weight: 600; border: none; border-radius: 8px;
      padding: 8px 12px; cursor: pointer; margin-right: 10px;
    }

    /* Expense List */
    .expense-list { list-style: none; padding: 0; margin: 0; }
    .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
    .expense-left { display: flex; align-items: center; gap: 12px; }
    .category-icon { width: 40px; height: 40px; background-color: #e0f2fe; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .expense-details h4 { margin: 0; font-size: 15px; font-weight: 600; }
    .expense-details p { margin: 2px 0 0; font-size: 12px; color: var(--text-muted); }
    .expense-amount { font-weight: 700; font-size: 15px; text-align: right; }
    .delete-expense { color: #cbd5e1; background: none; border: none; padding: 5px; margin: 0; width: auto; margin-left: 10px; }
    .delete-expense:hover { color: var(--danger); background: none; }

    /* Misc */
    .bmc-button {
      background-color: #FF813F !important; color: white !important;
      display: inline-flex; align-items: center; padding: 10px 20px;
      border-radius: 50px; text-decoration: none; font-weight: bold;
      box-shadow: 0 4px 10px rgba(255, 129, 63, 0.3);
    }
    .chart-container { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }
  </style>
</head>

<body>

  <header>
    <div><i class="fa-solid fa-mug-hot"></i> CoffeeMan Travel Travel Budget v2</div>
  </header>

  <div class="container" id="app">
    
    <div id="trip-list-view">
      <h3>My Trips</h3>
      <div id="trip-list"></div>
      
      <div class="card">
        <h3><i class="fa-solid fa-plus-circle"></i> Create New Trip</h3>
        <input type="text" id="new-trip" placeholder="Destination Name" />
        <input type="file" id="trip-image" accept="image/*" style="margin-top:10px" />
        <button onclick="createTrip()">Start Planning</button>
      </div>

      <div style="text-align: center; margin-top:30px;">
        <a href="https://www.buymeacoffee.com/coffeemantravel" target="_blank" class="bmc-button">
          <i class="fa-solid fa-coffee" style="margin-right:8px;"></i> Buy Me a Coffee
        </a>
      </div>
    </div>

    <div id="trip-detail-view" style="display:none;">
      <button class="back-btn" onclick="backToTrips()">
        <i class="fa-solid fa-chevron-left" style="margin-right: 5px;"></i> Back to Trips
      </button>
      
      <h2 id="trip-title" style="font-size: 24px; color: var(--primary-dark);"></h2>

      <div class="card">
        <div class="input-group">
          <select id="currency">
            <option value="RM">RM</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="SGD">SGD</option>
            <option value="THB">THB</option>
            <option value="AED">AED</option>
            <option value="AFN">AFN</option>
            <option value="ALL">ALL</option>
            <option value="AMD">AMD</option>
            <option value="ANG">ANG</option>
            <option value="AOA">AOA</option>
            <option value="ARS">ARS</option>
            <option value="AUD">AUD</option>
            <option value="AWG">AWG</option>
            <option value="AZN">AZN</option>
            <option value="BAM">BAM</option>
            <option value="BBD">BBD</option>
            <option value="BDT">BDT</option>
            <option value="BGN">BGN</option>
            <option value="BHD">BHD</option>
            <option value="BIF">BIF</option>
            <option value="BMD">BMD</option>
            <option value="BND">BND</option>
            <option value="BOB">BOB</option>
            <option value="BRL">BRL</option>
            <option value="BSD">BSD</option>
            <option value="BTN">BTN</option>
            <option value="BWP">BWP</option>
            <option value="BYN">BYN</option>
            <option value="BZD">BZD</option>
            <option value="CAD">CAD</option>
            <option value="CDF">CDF</option>
            <option value="CHF">CHF</option>
            <option value="CLP">CLP</option>
            <option value="CNY">CNY</option>
            <option value="COP">COP</option>
            <option value="CRC">CRC</option>
            <option value="CUP">CUP</option>
            <option value="CVE">CVE</option>
            <option value="CZK">CZK</option>
            <option value="DJF">DJF</option>
            <option value="DKK">DKK</option>
            <option value="DOP">DOP</option>
            <option value="DZD">DZD</option>
            <option value="EGP">EGP</option>
            <option value="ERN">ERN</option>
            <option value="ETB">ETB</option>
            <option value="FJD">FJD</option>
            <option value="FKP">FKP</option>
            <option value="FOK">FOK</option>
            <option value="GBP">GBP</option>
            <option value="GEL">GEL</option>
            <option value="GGP">GGP</option>
            <option value="GHS">GHS</option>
            <option value="GIP">GIP</option>
            <option value="GMD">GMD</option>
            <option value="GNF">GNF</option>
            <option value="GTQ">GTQ</option>
            <option value="GYD">GYD</option>
            <option value="HKD">HKD</option>
            <option value="HNL">HNL</option>
            <option value="HRK">HRK</option>
            <option value="HTG">HTG</option>
            <option value="HUF">HUF</option>
            <option value="IDR">IDR</option>
            <option value="ILS">ILS</option>
            <option value="IMP">IMP</option>
            <option value="INR">INR</option>
            <option value="IQD">IQD</option>
            <option value="IRR">IRR</option>
            <option value="ISK">ISK</option>
            <option value="JEP">JEP</option>
            <option value="JMD">JMD</option>
            <option value="JOD">JOD</option>
            <option value="JPY">JPY</option>
            <option value="KES">KES</option>
            <option value="KGS">KGS</option>
            <option value="KHR">KHR</option>
            <option value="KID">KID</option>
            <option value="KMF">KMF</option>
            <option value="KRW">KRW</option>
            <option value="KWD">KWD</option>
            <option value="KYD">KYD</option>
            <option value="KZT">KZT</option>
            <option value="LAK">LAK</option>
            <option value="LBP">LBP</option>
            <option value="LKR">LKR</option>
            <option value="LRD">LRD</option>
            <option value="LSL">LSL</option>
            <option value="LYD">LYD</option>
            <option value="MAD">MAD</option>
            <option value="MDL">MDL</option>
            <option value="MGA">MGA</option>
            <option value="MKD">MKD</option>
            <option value="MMK">MMK</option>
            <option value="MNT">MNT</option>
            <option value="MOP">MOP</option>
            <option value="MRU">MRU</option>
            <option value="MUR">MUR</option>
            <option value="MVR">MVR</option>
            <option value="MWK">MWK</option>
            <option value="MXN">MXN</option>
            <option value="MZN">MZN</option>
            <option value="NAD">NAD</option>
            <option value="NGN">NGN</option>
            <option value="NIO">NIO</option>
            <option value="NOK">NOK</option>
            <option value="NPR">NPR</option>
            <option value="NZD">NZD</option>
            <option value="OMR">OMR</option>
            <option value="PAB">PAB</option>
            <option value="PEN">PEN</option>
            <option value="PGK">PGK</option>
            <option value="PHP">PHP</option>
            <option value="PKR">PKR</option>
            <option value="PLN">PLN</option>
            <option value="PYG">PYG</option>
            <option value="QAR">QAR</option>
            <option value="RON">RON</option>
            <option value="RSD">RSD</option>
            <option value="RUB">RUB</option>
            <option value="RWF">RWF</option>
            <option value="SAR">SAR</option>
            <option value="SBD">SBD</option>
            <option value="SCR">SCR</option>
            <option value="SDG">SDG</option>
            <option value="SEK">SEK</option>
            <option value="SHP">SHP</option>
            <option value="SLE">SLE</option>
            <option value="SLL">SLL</option>
            <option value="SOS">SOS</option>
            <option value="SRD">SRD</option>
            <option value="SSP">SSP</option>
            <option value="STD">STD</option>
            <option value="SYP">SYP</option>
            <option value="SZL">SZL</option>
            <option value="TJS">TJS</option>
            <option value="TMT">TMT</option>
            <option value="TND">TND</option>
            <option value="TOP">TOP</option>
            <option value="TRY">TRY</option>
            <option value="TTD">TTD</option>
            <option value="TVD">TVD</option>
            <option value="TWD">TWD</option>
            <option value="TZS">TZS</option>
            <option value="UAH">UAH</option>
            <option value="UGX">UGX</option>
            <option value="UYU">UYU</option>
            <option value="UZS">UZS</option>
            <option value="VES">VES</option>
            <option value="VND">VND</option>
            <option value="VUV">VUV</option>
            <option value="WST">WST</option>
            <option value="XAF">XAF</option>
            <option value="XCD">XCD</option>
            <option value="XOF">XOF</option>
            <option value="XPF">XPF</option>
            <option value="YER">YER</option>
            <option value="ZAR">ZAR</option>
            <option value="ZMW">ZMW</option>
            <option value="ZWL">ZWL</option>
          </select>
          <input type="number" id="budget-input" placeholder="Total Budget" />
        </div>
        <button onclick="saveBudget()" style="margin-bottom: 15px;">Update Budget</button>
        
        <div class="budget-overview">
          <div style="font-size:14px; color:var(--text-muted)">Remaining</div>
          <div class="budget-amount-display" id="remaining-display">0.00</div>
          
          <div class="progress-container">
            <div class="progress-bar" id="budget-progress-bar"></div>
          </div>
          
          <div class="progress-text">
            <span id="spent-display">Spent: 0</span>
            <span id="total-display">Total: 0</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Add Expense</h3>
        <div style="display: flex; gap:10px;">
             <input type="number" id="amount-input" placeholder="0.00" style="flex:1" />
             <select id="category-input" style="flex:1">
              <option value="Food">Food</option>
              <option value="Hotel">Hotel</option>
              <option value="Transport">Transport</option>
              <option value="Shopping">Shopping</option>
              <option value="Ticket">Ticket</option>
              <option value="Other">Other</option>
            </select>
        </div>
        <input type="text" id="note-input" placeholder="Note" style="margin-top:10px"/>
        <button onclick="addExpense()"><i class="fa-solid fa-receipt"></i> Add Expense</button>
      </div>

      <div class="card">
        <h3>Breakdown</h3>
        <div class="chart-container"><canvas id="chart"></canvas></div>
      </div>

      <div class="card">
        <h3>Transactions</h3>
        <div id="expense-list-container" class="expense-list"></div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let trips = JSON.parse(localStorage.getItem("trips")) || [];
    let currentTripIndex = null;
    let pieChart = null;

    const categoryIcons = {
      'Food': 'fa-utensils',
      'Hotel': 'fa-bed',
      'Transport': 'fa-plane',
      'Shopping': 'fa-bag-shopping',
      'Ticket': 'fa-ticket',
      'Other': 'fa-circle-question'
    };

    // --- UPDATED SAVE FUNCTION WITH ERROR HANDLING ---
    function saveTrips() {
      try {
        localStorage.setItem("trips", JSON.stringify(trips));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          alert("Storage Limit Reached!\n\nThe image you selected is too large. The trip was NOT saved. Please try again with a smaller image or delete old trips.");
        } else {
          alert("Error saving data: " + e.message);
        }
        return false;
      }
    }

    function showTrips() {
      const list = document.getElementById("trip-list");
      list.innerHTML = "";
      
      if(trips.length === 0) {
          list.innerHTML = `<div style="grid-column: 1/-1; text-align:center; color:#888;">No trips yet. Start an adventure!</div>`;
          return;
      }

      trips.forEach((trip, i) => {
        const card = document.createElement("div");
        card.className = "trip-card";
        const imgSrc = trip.image || "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&w=500&q=80"; 
        
        card.innerHTML = `
          <img src="${imgSrc}" class="trip-img" alt="${trip.name}">
          <button class="delete-trip-btn" onclick="deleteTrip(event, ${i})"><i class="fa-solid fa-times"></i></button>
          <div class="trip-info">
            <div class="trip-name">${trip.name}</div>
            <div style="font-size:12px; color:#666;">${trip.currency} ${trip.budget}</div>
          </div>
        `;
        card.onclick = () => openTrip(i);
        list.appendChild(card);
      });
    }

    function createTrip() {
      const name = document.getElementById("new-trip").value.trim();
      const fileInput = document.getElementById("trip-image");
      
      if (!name) return alert("Please enter a destination name");

      const processTrip = (imgData) => {
        // Add to array temporarily
        trips.push({
          name,
          image: imgData,
          budget: 0,
          currency: "RM",
          expenses: []
        });

        // Try to save
        const saved = saveTrips();

        if (saved) {
          // If successful, reset form and show list
          document.getElementById("new-trip").value = "";
          fileInput.value = "";
          showTrips();
        } else {
          // If save failed (too big), remove the item we just pushed
          trips.pop(); 
        }
      };

      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => processTrip(e.target.result);
        
        // Safety: If image is > 3MB, warn user before trying (optional check)
        if(fileInput.files[0].size > 3000000) {
            if(!confirm("This image is large (>3MB) and might fill your storage. Continue?")) {
                fileInput.value = ""; // clear
                return; 
            }
        }
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        processTrip(""); 
      }
    }

    function deleteTrip(e, index) {
      e.stopPropagation();
      if (confirm("Delete this trip?")) {
        trips.splice(index, 1);
        saveTrips();
        showTrips();
      }
    }

    function openTrip(index) {
      currentTripIndex = index;
      const trip = trips[index];
      document.getElementById("trip-list-view").style.display = "none";
      document.getElementById("trip-detail-view").style.display = "block";
      document.getElementById("trip-title").innerText = trip.name;
      document.getElementById("budget-input").value = trip.budget > 0 ? trip.budget : "";
      document.getElementById("currency").value = trip.currency || "RM";
      window.scrollTo(0, 0);
      updateUI();
    }

    function backToTrips() {
      currentTripIndex = null;
      document.getElementById("trip-detail-view").style.display = "none";
      document.getElementById("trip-list-view").style.display = "block";
      showTrips();
    }

    function saveBudget() {
      const val = parseFloat(document.getElementById("budget-input").value);
      const curr = document.getElementById("currency").value;
      if (isNaN(val) || val < 0) return alert("Enter a valid budget");
      
      trips[currentTripIndex].budget = val;
      trips[currentTripIndex].currency = curr;
      if(saveTrips()) {
        updateUI();
        alert("Budget updated");
      }
    }

    function addExpense() {
      const amount = parseFloat(document.getElementById("amount-input").value);
      const category = document.getElementById("category-input").value;
      const note = document.getElementById("note-input").value.trim();
      
      if (isNaN(amount) || amount <= 0) return alert("Enter a valid amount");

      trips[currentTripIndex].expenses.push({ amount, category, note });
      if(saveTrips()) {
          document.getElementById("amount-input").value = "";
          document.getElementById("note-input").value = "";
          updateUI();
      } else {
          // If save fails, remove the expense from memory
          trips[currentTripIndex].expenses.pop();
      }
    }

    function deleteExpense(originalIndex) {
        if(confirm("Remove this expense?")) {
            trips[currentTripIndex].expenses.splice(originalIndex, 1);
            saveTrips();
            updateUI();
        }
    }

    function updateUI() {
      const trip = trips[currentTripIndex];
      const currency = trip.currency || "RM";
      const totalSpent = trip.expenses.reduce((sum, e) => sum + e.amount, 0);
      const remaining = trip.budget - totalSpent;
      
      document.getElementById("remaining-display").innerText = `${currency} ${remaining.toFixed(2)}`;
      document.getElementById("spent-display").innerText = `Spent: ${currency}${totalSpent.toFixed(2)}`;
      document.getElementById("total-display").innerText = `Total: ${currency}${trip.budget}`;
      
      const percentage = trip.budget > 0 ? (totalSpent / trip.budget) * 100 : 0;
      const bar = document.getElementById("budget-progress-bar");
      bar.style.width = `${Math.min(percentage, 100)}%`;
      
      if (remaining < 0) {
        bar.style.backgroundColor = "#ef4444";
        document.getElementById("remaining-display").style.color = "#ef4444";
      } else {
        bar.style.backgroundColor = "#0ea5e9";
        document.getElementById("remaining-display").style.color = "#0ea5e9";
      }

      const listContainer = document.getElementById("expense-list-container");
      listContainer.innerHTML = "";
      
      if(trip.expenses.length === 0) {
          listContainer.innerHTML = `<div style="text-align:center; color:#999; padding:20px;">No expenses yet.</div>`;
      } else {
          trip.expenses.slice().reverse().forEach((e, revIndex) => {
            const originalIndex = trip.expenses.length - 1 - revIndex;
            const item = document.createElement("div");
            item.className = "expense-item";
            const iconClass = categoryIcons[e.category] || 'fa-circle-question';
            item.innerHTML = `
              <div class="expense-left">
                <div class="category-icon"><i class="fa-solid ${iconClass}"></i></div>
                <div class="expense-details">
                  <h4>${e.category}</h4>
                  <p>${e.note || 'No note'}</p>
                </div>
              </div>
              <div class="expense-right">
                <div class="expense-amount">-${currency} ${e.amount.toFixed(2)}</div>
                <button class="delete-expense" onclick="deleteExpense(${originalIndex})"><i class="fa-solid fa-trash"></i></button>
              </div>
            `;
            listContainer.appendChild(item);
          });
      }
      renderChart(trip);
    }

    function renderChart(trip) {
      const ctx = document.getElementById("chart").getContext("2d");
      const sums = {};
      trip.expenses.forEach(e => { sums[e.category] = (sums[e.category] || 0) + e.amount; });
      const labels = Object.keys(sums);
      const data = Object.values(sums);

      if (pieChart) pieChart.destroy();
      
      if(labels.length === 0) {
          ctx.clearRect(0,0, ctx.canvas.width, ctx.canvas.height);
          return;
      }

      pieChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: ['#0ea5e9', '#38bdf8', '#7dd3fc', '#bae6fd', '#0284c7', '#f472b6'],
            borderWidth: 2, borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } } },
          cutout: '60%'
        }
      });
    }

    showTrips();
  </script>
</body>
</html>
